<!DOCTYPE html>
<html lang="ja-JP">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Nobwak&#39;s Lair  | [メモ]zpoolのupgrade</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.54.0" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.d98f2eb6bcd1eaedb7edf166bd16af26.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="[メモ]zpoolのupgrade" />
<meta property="og:description" content="zpoolのupgradeをしたのでメモ。 結論としては、zpoolのupgradeとは、単にversionを上げるだけ以外にもあるようだ。 legacy" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://nobwak.github.io/posts/2013-12-13-%E3%83%A1%E3%83%A2zpool%E3%81%AEupgrade/" />
<meta property="article:published_time" content="2013-12-13T22:08:35&#43;09:00"/>
<meta property="article:modified_time" content="2013-12-13T22:08:35&#43;09:00"/>

<meta itemprop="name" content="[メモ]zpoolのupgrade">
<meta itemprop="description" content="zpoolのupgradeをしたのでメモ。 結論としては、zpoolのupgradeとは、単にversionを上げるだけ以外にもあるようだ。 legacy">


<meta itemprop="datePublished" content="2013-12-13T22:08:35&#43;09:00" />
<meta itemprop="dateModified" content="2013-12-13T22:08:35&#43;09:00" />
<meta itemprop="wordCount" content="932">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[メモ]zpoolのupgrade"/>
<meta name="twitter:description" content="zpoolのupgradeをしたのでメモ。 結論としては、zpoolのupgradeとは、単にversionを上げるだけ以外にもあるようだ。 legacy"/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://nobwak.github.io/" class="f3 fw2 hover-white no-underline white-90 dib">
      Nobwak&#39;s Lair
    </a>
    <div class="flex-l items-center">
      

      
      











    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1">[メモ]zpoolのupgrade</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2013-12-13T22:08:35&#43;09:00">December 13, 2013</time>      
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l">

<p>zpoolのupgradeをしたのでメモ。<br />
結論としては、zpoolのupgradeとは、単にversionを上げるだけ以外にもあるようだ。</p>

<h2 id="span-style-text-decoration-underline-legacy-on-disk-formatでformat-span"><span style="text-decoration: underline;">legacy on-disk formatでformat??</span></h2>

<p>気がつくと、zpool statusで文句を言われていた。</p>

<pre><code class="language-console">$ zpool status
  pool: vault
 state: ONLINE
status: The pool is formatted using a legacy on-disk format.  The pool can
        still be used, but some features are unavailable.
action: Upgrade the pool using 'zpool upgrade'.  Once this is done, the
        pool will no longer be accessible on software that does not support feature
        flags.
(略)
</code></pre>

<p>曰く、「このpoolはlegacy on-disk formatでフォーマットされている。<br />
もちろんpoolは引き続き使えるけれども、いくかの機能が使えない。」とのこと。</p>

<p>zpoolを調べてみたが、最新のv28である。</p>

<pre><code class="language-console">$ zpool get all|grep vault
vault      size                   2.27T                  -
vault      capacity               64%                    -
vault      health                 ONLINE                 -
vault      version                28                     local
（略）
</code></pre>

<p>zpool upgradeで調べて分かってきた。<br />
zpoolバージョンではなくfeature flagsのことを言っているわけだ。</p>

<pre><code class="language-console">$ zpool upgrade
This system supports ZFS pool feature flags.

The following pools are formatted with legacy version numbers and can
be upgraded to use feature flags.  After being upgraded, these pools
will no longer be accessible by software that does not support feature
flags.

VER  POOL
---  ------------
28   vault

Use 'zpool upgrade -v' for a list of available legacy versions.
Every feature flags pool has all supported features enabled.
</code></pre>

<p>で、もういちど調べてみると。</p>

<pre><code class="language-console">$ zpool get all|grep vault
vault      size                   2.27T                  -
vault      capacity               64%                    -
vault      health                 ONLINE                 -
vault      version                28                     local
（略）
vault      feature@async_destroy  disabled               local
vault      feature@empty_bpobj    disabled               local
vault      feature@lz4_compress   disabled               local
</code></pre>

<p>featureがいくつかdiabledになっている。<br />
そうと分かれば素直にupgradeである。</p>

<h2 id="span-style-text-decoration-underline-zpoolのupgrade-span"><span style="text-decoration: underline;">zpoolのupgrade</span></h2>

<p>zpool upgradeとするだけ。<br />
ただ、バージョンが変わらないとはいえ、ファイルシステムの基盤をアップグレードするわけだからバックアップは取っといた。</p>

<pre><code class="language-console">$ sudo zpool upgrade vault
This system supports ZFS pool feature flags.

Successfully upgraded 'vault' from version 28 to feature flags.
Enabled the following features on 'vault':
  async_destroy
  empty_bpobj
  lz4_compress
</code></pre>

<p>あっけなく終了。</p>

<p>調べてみるとversionが消えて（なぜ&hellip;.でもpropertiesがdefaultだからよしとしよう）、その代りfeatureはすべてenabledに変化したことが分かる。<br />
なお、enabledは「その機能が使えますよ」という表示。<br />
実際に有効にするとenabledはactiveに変化する。</p>

<pre><code class="language-console">$ zpool get all|grep vault
vault      size                   2.27T                  -
vault      capacity               64%                    -
vault      health                 ONLINE                 -
vault      version                -                      default
（略）
vault      feature@async_destroy  enabled                local
vault      feature@empty_bpobj    enabled                local
vault      feature@lz4_compress   enabled                local
</code></pre>

<p>zpool upgrade、zpool statusの表示いずれも問題なし。</p>

<pre><code class="language-console">$ zpool upgrade
This system supports ZFS pool feature flags.

All pools are formatted using feature flags.

Every feature flags pool has all supported features enabled.

$ zpool status
  pool: vault
 state: ONLINE
  scan: scrub repaired 0 in 4h53m with 0 errors on Sat Jul 27 14:35:23 2013
config:

        NAME        STATE     READ WRITE CKSUM
        vault       ONLINE       0     0     0
          ada1      ONLINE       0     0     0

errors: No known data errors
</code></pre>
<ul class="pa0">
  
</ul>
<div class="mt6">
        
      </div>
    </section>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://nobwak.github.io/" >
    &copy; 2019 Nobwak&#39;s Lair
  </a>
    <div>










</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
