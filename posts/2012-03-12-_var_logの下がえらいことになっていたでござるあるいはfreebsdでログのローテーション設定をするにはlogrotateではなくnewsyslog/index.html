<!DOCTYPE html>
<html lang="ja-JP">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Nobwak&#39;s Lair  | /var/logの下がえらいことになっていたでござる。（あるいはFreeBSDでログのローテーション設定をするには(logrotateではなくnewsyslog))。</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.54.0" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.d98f2eb6bcd1eaedb7edf166bd16af26.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="/var/logの下がえらいことになっていたでござる。（あるいはFreeBSDでログのローテーション設定をするには(logrotateではなくnewsyslog))。" />
<meta property="og:description" content="ある日、ふと/var/logの下を見てみたら、1.5GBytesに膨れ上がった某ログファイルがあって腰を抜かした件について。 思えば、サーバソ" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://nobwak.github.io/posts/2012-03-12-_var_log%E3%81%AE%E4%B8%8B%E3%81%8C%E3%81%88%E3%82%89%E3%81%84%E3%81%93%E3%81%A8%E3%81%AB%E3%81%AA%E3%81%A3%E3%81%A6%E3%81%84%E3%81%9F%E3%81%A7%E3%81%94%E3%81%96%E3%82%8B%E3%81%82%E3%82%8B%E3%81%84%E3%81%AFfreebsd%E3%81%A7%E3%83%AD%E3%82%B0%E3%81%AE%E3%83%AD%E3%83%BC%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E8%A8%AD%E5%AE%9A%E3%82%92%E3%81%99%E3%82%8B%E3%81%AB%E3%81%AFlogrotate%E3%81%A7%E3%81%AF%E3%81%AA%E3%81%8Fnewsyslog/" />
<meta property="article:published_time" content="2012-03-12T01:00:00&#43;09:00"/>
<meta property="article:modified_time" content="2012-03-12T01:00:00&#43;09:00"/>

<meta itemprop="name" content="/var/logの下がえらいことになっていたでござる。（あるいはFreeBSDでログのローテーション設定をするには(logrotateではなくnewsyslog))。">
<meta itemprop="description" content="ある日、ふと/var/logの下を見てみたら、1.5GBytesに膨れ上がった某ログファイルがあって腰を抜かした件について。 思えば、サーバソ">


<meta itemprop="datePublished" content="2012-03-12T01:00:00&#43;09:00" />
<meta itemprop="dateModified" content="2012-03-12T01:00:00&#43;09:00" />
<meta itemprop="wordCount" content="1756">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="/var/logの下がえらいことになっていたでござる。（あるいはFreeBSDでログのローテーション設定をするには(logrotateではなくnewsyslog))。"/>
<meta name="twitter:description" content="ある日、ふと/var/logの下を見てみたら、1.5GBytesに膨れ上がった某ログファイルがあって腰を抜かした件について。 思えば、サーバソ"/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://nobwak.github.io/" class="f3 fw2 hover-white no-underline white-90 dib">
      Nobwak&#39;s Lair
    </a>
    <div class="flex-l items-center">
      

      
      











    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1">/var/logの下がえらいことになっていたでござる。（あるいはFreeBSDでログのローテーション設定をするには(logrotateではなくnewsyslog))。</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2012-03-12T01:00:00&#43;09:00">March 12, 2012</time>      
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><pre><code>ある日、ふと/var/logの下を見てみたら、1.5GBytesに膨れ上がった某ログファイルがあって腰を抜かした件について。






思えば、サーバソフトウェアなどでは、インストールしたらまずそのものの設定で頭が一杯だ。



一方で、いわゆるシモの世話といいますか、吐き出すログの設定には頭が回ってなかったことに深く反省するのであります。






俺の例でいえば、apache、clamav、dhcpdのログが手つかずでありました（冒頭、1.5GBytesになっていたログはdhcpdのもの）。



portsから入れたサーバのログは、いちど確認したほうがいいだろう。



基本は/var/logの下に出力されるが、/usr/local/var/logが（あれば）見た方がいいし、場合によっては思わぬところに吐き出されてる可能性もある。






&lt;span style=&quot;font-weight:bold;&quot; class=&quot;deco&quot;&gt;newsyslogd&lt;/span&gt;



さて、FreeBSDではログのローテートはnewsyslogdが行う。Linuxではlogrotateにあたるもの。






handbookではこのへん



英語（推奨）



&lt;a href=&quot;http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/configtuning-configfiles.html&quot; target=&quot;_blank&quot;&gt;http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/configtuning-configfiles.html&lt;/a&gt;



日本語



&lt;a href=&quot;http://www.freebsd.org/doc/ja_JP.eucJP/books/handbook/book.html#CONFIGTUNING-CONFIGFILES&quot; target=&quot;_blank&quot;&gt;http://www.freebsd.org/doc/ja_JP.eucJP/books/handbook/book.html#CONFIGTUNING-CONFIGFILES&lt;/a&gt;






&lt;span style=&quot;font-weight:bold;&quot; class=&quot;deco&quot;&gt;newsyslogの設定サンプル&lt;/span&gt;



man newsyslog.confを見ればだいたい分かる。以降、英文はここからの引用。



&lt;a href=&quot;http://www.freebsd.org/cgi/man.cgi?query=newsyslog.conf&amp;#038;apropos=0&amp;#038;sektion=0&amp;#038;manpath=FreeBSD+9.0-RELEASE&amp;#038;arch=default&amp;#038;format=html&quot; target=&quot;_blank&quot;&gt;http://www.freebsd.org/cgi/man.cgi?query=newsyslog.conf&amp;apropos=0&amp;sektion=0&amp;manpath=FreeBSD+9.0-RELEASE&amp;arch=default&amp;format=html&lt;/a&gt;






以下の順番で並べるだけ。間はスペースで埋めること（separated with whitespace）。
</code></pre>

<pre><code class="language-console"># filename          &amp;#91;owner:group]    mode count size when &amp;#91;ZB] &amp;#91;/pid_file] &amp;#91;sig_num]
</code></pre>

<pre><code>以下、サンプル。
</code></pre>

<pre><code class="language-console">/var/log/local7.log    600  10 1024 * JC
</code></pre>

<pre><code>/var/log/local7.logが、1MBytesを超えた時点でローテーション。



生成されたログのパーミッションは600で、bzip2で圧縮され（J）、10個保存される。
</code></pre>

<pre><code class="language-console">/var/log/httpd-access.log    644  7 * @T03 JC
</code></pre>

<pre><code>apacheのログを毎日午前3時にローテーション、圧縮して7日分残す。



設定を変えたらnewsyslogdを再起動。
</code></pre>

<pre><code class="language-console"># /etc/rc.d/newsyslog restart
Creating and/or trimming log files.
#
</code></pre>

<pre><code>&lt;span style=&quot;font-weight:bold;&quot; class=&quot;deco&quot;&gt;設定について&lt;/span&gt;






&lt;span style=&quot;font-style:italic;&quot; class=&quot;deco&quot;&gt;filename&lt;/span&gt;



　その名の通り。



&lt;span style=&quot;font-style:italic;&quot; class=&quot;deco&quot;&gt;[owner:group]&lt;/span&gt;



　省略可。アーカイブ後ファイルの所有ユーザとグループ



&lt;span style=&quot;font-style:italic;&quot; class=&quot;deco&quot;&gt;mode&lt;/span&gt;



　ログファイルとアーカイブ後ファイルのパーミッション。



　サーバソフトが作るオリジナルのパーミッションと合わせておくのがよい。



　というのも、newsyslogdがログをローテーションするときに新しいログファイルを作るから。



　owner:groupにはなく、こちらにだけ「ログファイル」という記載があるのはなぜでしょうな。



&lt;span style=&quot;font-style:italic;&quot; class=&quot;deco&quot;&gt;count&lt;/span&gt;



　残す「アーカイブ後の」ログファイル数。



　3なら、アーカイブされたログが3つになる。



&lt;span style=&quot;font-style:italic;&quot; class=&quot;deco&quot;&gt;size&lt;/span&gt;



　このサイズを超えたときにローテーションされる。



　キロバイトで指定。



　アスタリスク(*)の場合には、サイズベースでのローテーションはしない。



&lt;span style=&quot;font-style:italic;&quot; class=&quot;deco&quot;&gt;when&lt;/span&gt;



　ローテーションする時間、時刻契機を指定。



　インターバル、時刻を指定できる。



　書式は二つ。後述する。



　注意すべき点は、newsyslog自体が一時間に一回しか起動しないこと。



　これはつまり以下のような動作となる、と理解した。



　・仮に、newsyslogdが毎時0分に起動し、かつ



　・毎時1分にローテーションする設定にした場合、



　→例えば、1時1分ではなく、2時にローテーションが発生する。



newsyslog.conf(5)より抜粋
</code></pre>

<p><blockquote></p>

<pre><code>  If a time is specified, the log file will only be trimmed if newsyslog(8) is run within one hour of the specified time. If an interval is specified, the log file will be trimmed if that many hours have passed since the last rotation.
</code></pre>

<p></blockquote></p>

<pre><code>　書式
</code></pre>

<p><blockquote></p>

<pre><code>  　@で書くもの、$で書くものの二つ。



  　@は、[cc]yy]mm]dd][T[hh[mm[ss&lt;a class=&quot;keyword&quot; href=&quot;http://d.hatena.ne.jp/keyword/%5B%5B%5Bcc%5Dyy%5Dmm%5Ddd%5D%5BT%5Bhh%5Bmm%5Bss?mode=edit&quot; rel=&quot;nofollow&quot;&gt;?&lt;/a&gt;]



  　$は、[Dhh], [Ww[Dhhと[Mdd[Dhh



  　サンプルを見るのが一番よい。（これもmanから抜粋）



  　$D0　毎日午前0時。@T00と同じ意味



  　$D23　毎日23時。@T23と同じ意味



  　$W0D23　毎週日曜23時



  　$W5D16　毎週金曜16時



  　$M1D0　毎月1日の午前0時。@01T00と同じ意味



  　$M5D6　毎月5日の午前6時。@05T06と同じ意味
</code></pre>

<p></blockquote></p>

<pre><code>&lt;span style=&quot;font-style:italic;&quot; class=&quot;deco&quot;&gt;flags&lt;/span&gt; 一部のみ。基本JCでよい。



　J ログをbzip2で圧縮。Zならgzip。Xならxz。



　C ログが存在しない場合に作る。



　G パターンにマッチしたログファイルを対象にできる。



　



&lt;span style=&quot;font-style:italic;&quot; class=&quot;deco&quot;&gt;pid_file&lt;/span&gt;



　通常、ログをローテーションした後はsyslogdにシグナルが送られる。



　syslogd以外のプロセスにシグナルを送りたい場合には、プロセスの



　pidが書かれたファイルをここで指定する。






以上
</code></pre>
<ul class="pa0">
  
</ul>
<div class="mt6">
        
      </div>
    </section>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://nobwak.github.io/" >
    &copy; 2019 Nobwak&#39;s Lair
  </a>
    <div>










</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
