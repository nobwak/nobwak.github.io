<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Windows7でsambaのファイルがうまく開けない件について（oplocks死すべし） | nobwak's Lair</title><meta name=keywords content="FreeBSD,linux,Samba,Windows"><meta name=description content="昨年あたりからWindows XPのサポート終了にともない、Windows 7へクライアントOSを移す企業が多い。 私の仕事PCも過日、ついに7に"><meta name=author content="nobwak"><link rel=canonical href=https://nobwak.github.io/posts/2014-01-26-windows7%E3%81%A7samba%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8C%E3%81%86%E3%81%BE%E3%81%8F%E9%96%8B%E3%81%91%E3%81%AA%E3%81%84%E4%BB%B6%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6oplocks%E6%AD%BB%E3%81%99%E3%81%B9%E3%81%97/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style><link rel=preload href=/apple-touch-icon.png as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://nobwak.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://nobwak.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://nobwak.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://nobwak.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://nobwak.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.96.0"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Windows7でsambaのファイルがうまく開けない件について（oplocks死すべし）"><meta property="og:description" content="昨年あたりからWindows XPのサポート終了にともない、Windows 7へクライアントOSを移す企業が多い。 私の仕事PCも過日、ついに7に"><meta property="og:type" content="article"><meta property="og:url" content="https://nobwak.github.io/posts/2014-01-26-windows7%E3%81%A7samba%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8C%E3%81%86%E3%81%BE%E3%81%8F%E9%96%8B%E3%81%91%E3%81%AA%E3%81%84%E4%BB%B6%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6oplocks%E6%AD%BB%E3%81%99%E3%81%B9%E3%81%97/"><meta property="og:image" content="https://nobwak.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2014-01-26T20:19:00+09:00"><meta property="article:modified_time" content="2014-01-26T20:19:00+09:00"><meta property="og:site_name" content="nobwak's Lair"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://nobwak.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Windows7でsambaのファイルがうまく開けない件について（oplocks死すべし）"><meta name=twitter:description content="昨年あたりからWindows XPのサポート終了にともない、Windows 7へクライアントOSを移す企業が多い。 私の仕事PCも過日、ついに7に"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://nobwak.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Windows7でsambaのファイルがうまく開けない件について（oplocks死すべし）","item":"https://nobwak.github.io/posts/2014-01-26-windows7%E3%81%A7samba%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8C%E3%81%86%E3%81%BE%E3%81%8F%E9%96%8B%E3%81%91%E3%81%AA%E3%81%84%E4%BB%B6%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6oplocks%E6%AD%BB%E3%81%99%E3%81%B9%E3%81%97/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Windows7でsambaのファイルがうまく開けない件について（oplocks死すべし）","name":"Windows7でsambaのファイルがうまく開けない件について（oplocks死すべし）","description":"昨年あたりからWindows XPのサポート終了にともない、Windows 7へクライアントOSを移す企業が多い。 私の仕事PCも過日、ついに7に","keywords":["FreeBSD","linux","Samba","Windows"],"articleBody":"昨年あたりからWindows XPのサポート終了にともない、Windows 7へクライアントOSを移す企業が多い。\n私の仕事PCも過日、ついに7に変更された。\nさすがに色んなところが改善されていて使いやすくなっているのだが、なぜかSambaに置いてあるファイルが壊れたり、誰も開いていないはずなのに読み取り専用でしか開けない事象が頻発した。\n特に共有設定したOfficeドキュメントで顕著。\nしばらく悩んでいたのだが、Sambaのログにoplocks failedという記録を見つけて（おそらく）対処方法が分かった。\n以下に示す。\nSambaのバージョンは3.6.22である。\n結論 smb.confのglobalセクションに以下を書け。\noplocks = No blocking locks = No ネタ元 ネットを渉猟したところ、やはりOplocksの評判はあまりよくない。\n以下のホワイトペーパーが分かりやすかった。\nOplocksとread cachingが原因と断定している。\nOpportunistic Locking and Read Caching on Microsoft Windows Networks\nhttp://www.dataaccess.com/whitepapers/opportunlockingreadcaching.html\n先に進む前にプロトコルとしてのSMBでいくつか確認を。\nSMB（プロトコル）のバージョンについて Windowsファイル共有で使われるプロトコルSMBは、Vistaでバージョン2, 7でバージョン2.1になった。\nOplocksとread cachingもバージョン2以降で追加、あるいは強化されている。\n詳細は以下。\nSMB の新機能\nhttp://technet.microsoft.com/ja-jp/library/ff625695.aspx\nSMB1⇒2⇒2.1への変化と新機能\nhttp://blog.goo.ne.jp/mito_and_tanu/e/10c47629fbb7e7d3d73cbd54a1a9f28d\nOplocksとは ネットワークの効率化を狙う、Windows固有の機能。\n複数のプロセスが同じファイルをロックでき、なおかつクライアントがデータをキャッシュできる。\nChapter 17. File and Record Locking\nhttp://www.samba.org/samba/docs/man/Samba-HOWTO-Collection/locking.html\nhttp://www.samba.gr.jp/project/translation/Samba3-HOWTO/locking.html\nRead Cachingとは Oplocksの一機能。クライアント側でのデータキャッシュ。\nクライアントがローカルでデータをキャッシュする目的は、ネットワーク越しの書き込み回数を減らすこと、ひいてはネットワークの効率化のため。\nファイルの同じ部分（the same region）に対する書き込みをまとめて、一回で済ませる。\nOplocksの危険性 Oplocksが狙い通りに動けば、目的通りネットワークの効率化が図られる。\n問題なのはネットワークに何か問題が起こり、キャッシュが適切にフラッシュされない場合。ともするとファイルの破壊を引き起こす。\nとくにデータベースが危険。\n以下のリンクに詳細が。\n本記事の末尾に私訳を付す。\nLocks and Oplocks\nhttp://www.samba.org/samba/docs/using_samba/ch08.html\n対策:Oplocksを無効にしろ ここまで分かれば、対策は簡単。\nOplocksを無効にすればよい。\n無効にする方法には、サーバ側での方法、クライアント側での方法がある。\nクライアントと言っても、たいていはWindowsであろうが、Windowsで対処しようとするとレジストリの変更が必要になる。\nさすがにそれは面倒だ。\nそこでサーバ側、Sambaの設定でOplocksを無効にする。\nsmb.confでOplocksを無効にする oplocks = noとすればよい。\nデフォルト無効にしたければ[global]セクションに、共有ごとに無効にしたければ共有のところに書けばよい。\nsmb.confのmanは一見、共有ごとにしか指定できないように見えるかもしれないが[global]にも使える。\nまた、oplocksはbooleanなのでnoでもfalseでも、はたまた0でも理解してもらえる。\nなお、ファイルごとに有効無効を指定したければveto oplock filesで指定できる。\nsmb.confのmanより抜粋\noplocks (S) This boolean option tells smbd whether to issue oplocks (opportunistic locks) to file open requests on this share. （略） Default: oplocks = yes smb.confのmanよりPARAMETERS抜粋\nPARAMETERS （略） The letter G in parentheses indicates that a parameter is specific to the [global] section. The letter S indicates that a parameter can be specified in a service specific section. All S parameters can also be specified in the [global] section - in which case they will define the default behavior for all services. blocking locks Sambaはロックの方法を指定できる。\nblocking locksというものである。\nこれは、ファイルをロックするときに、特定部分だけをロック（range lock）するか、ファイル全体をロックするか、というものである。\nデフォルトで有効。\nWindowsのRead Cachingに対応してそうな機能である。\n加えてmanを見ると、「range lockに失敗すると、タイムアウトするまで何回かrange lockを再試行する」などと書いてある。\nこれも無効にしよう。\nblocking locks (S) This parameter controls the behavior of smbd(8) when given a request by a client to obtain a byte range lock on a region of an open file, and the request has a time limit associated with it. If this parameter is set and the lock range requested cannot be immediately satisfied, samba will internally queue the lock request, and periodically attempt to obtain the lock until the timeout period expires. If this parameter is set to no, then samba will behave as previous versions of Samba would and will fail the lock request immediately if the lock range cannot be obtained. Default: blocking locks = yes 設定例 以上を踏まえて、以下のように設定\nしょぼい英文は勘弁しておくれ。\n[global] (略) # # Disable oplock # It's supposed to improve network performance but causes problems # # See: # Opportunistic Locking and Read Caching on Microsoft Windows Networks # http://www.dataaccess.com/whitepapers/opportunlockingreadcaching.html # oplocks = no blocking locks = no 再起動しておしまい。\n$ sudo service samba restart Performing sanity check on Samba configuration: OK Stopping winbindd. Waiting for PIDS: 667. Stopping smbd. Waiting for PIDS: 664, 664. Stopping nmbd. Waiting for PIDS: 661. Removing stale Samba tdb files: .. done Starting nmbd. Starting smbd. Starting winbindd. （参考）Locks and Oplocks 私訳 http://www.samba.org/samba/docs/using_samba/ch08.html\nLocks and Oplocks\noplocksの使用によって得られるパフォーマンス増は、大変に望ましいことがほとんどだ。\nしかしながら、クライアントやネットワークのハードウェアの信頼性が怪しいような状況では、クライアントにデータをキャッシュさせることは大きなリスクになり得る。\nクライアントが書き込みのためにファイルを開き、oplockを行う場合を考えてみよう。\nそして他のクライアントが同じファイルを開こうとしたとき、“oplock break\"要求が最初のクライアントに送られる。\nもしこの要求が何らかの理由により失敗し、二番目のクライアントがファイルの書き込みをしたとする。\n二つのプロセスが同時に書き込みをするわけだから、ファイルは簡単に壊れてしまうだろう。\n残念なことに上記のケースは現実に起こりうる。\nSMBネットワークにおける複数のWindowsクライアント環境では、このようなおかしな動きは頻繁にみられる。\nたくさんのクライアントが同時に書き込みを行うデータベースファイルは特に影響を受けてしまう。\noplocksの失敗するもっと具体的な例を挙げると、それはデータベースファイルが大変に大きい場合である。\nクライアントがこのようなファイルを開き、oplockを許可されると、非常に大きな遅延が発生する。\nその一部を修正するためだけであっても、クライアントがファイル全部をキャッシュするからである。\nこのファイルを別のクライアントが開こうとしたとき、状況はさらに悪くなる。\n二番目のクライアントがファイルを開くためには、最初のクライアントがキャッシュをすべてサーバに書き戻す必要があるからだ。\nこのために、また別の遅延が発生する（しかも双方のクライアントで）。\n結果として、タイムアウトにより二番目のクライアントがファイルオープンに失敗し、たぶんデータが壊れた旨のWarning messageも併せて表示されるだろう。\nIn most cases, the extra performance resulting from the use of oplocks is highly desirable. However, allowing the client to cache data can be a big risk if either the client or network hardware are unreliable. Suppose a client opens a file for writing, creating an oplock on it. When another client also tries to open the file, an oplock break request is sent to the first client. If this request goes unfulfilled for any reason and the second client starts writing to the file, the file can be easily corrupted as a result of the two processes writing to it concurrently. Unfortunately, this scenario is very real. Uncoordinated behavior such as this has been observed many times among Windows clients in SMB networks (with files served by Windows NT/2000 or Samba). Typically, the affected files are database files, which multiple clients open concurrently for writing.\nA more concrete example of oplock failure occurs when database files are very large. If a client is allowed to oplock this kind of file, there can be a huge delay while the client copies the entire file from the server to cache it, even though it might need to update only one record. The situation goes from bad to worse when another client tries to open the oplocked file. The first client might need to write the entire file back to the server before the second client’s file open request can succeed. This results in another huge delay (for both clients), which in practice often results in a failed open due to a timeout on the second client, perhaps along with a message warning of possible database corruption!\n","wordCount":"3069","inLanguage":"en","datePublished":"2014-01-26T20:19:00+09:00","dateModified":"2014-01-26T20:19:00+09:00","author":{"@type":"Person","name":"nobwak"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://nobwak.github.io/posts/2014-01-26-windows7%E3%81%A7samba%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%8C%E3%81%86%E3%81%BE%E3%81%8F%E9%96%8B%E3%81%91%E3%81%AA%E3%81%84%E4%BB%B6%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6oplocks%E6%AD%BB%E3%81%99%E3%81%B9%E3%81%97/"},"publisher":{"@type":"Organization","name":"nobwak's Lair","logo":{"@type":"ImageObject","url":"https://nobwak.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://nobwak.github.io accesskey=h title="Home (Alt + H)"><img src=https://nobwak.github.io/apple-touch-icon.png alt=logo aria-label=logo height=35>Home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://nobwak.github.io/posts/ title=posts><span>posts</span></a></li><li><a href=https://nobwak.github.io/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://nobwak.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://nobwak.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://nobwak.github.io title="nobwak lair"><span>nobwak lair</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://nobwak.github.io>Home</a>&nbsp;»&nbsp;<a href=https://nobwak.github.io/posts/>Posts</a></div><h1 class=post-title>Windows7でsambaのファイルがうまく開けない件について（oplocks死すべし）</h1><div class=post-meta><span title="2014-01-26 20:19:00 +0900 JST">January 26, 2014</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;nobwak&nbsp;|&nbsp;<a href=https://nobwak.github.io/content/posts/2014-01-26-Windows7%e3%81%a7samba%e3%81%ae%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%8c%e3%81%86%e3%81%be%e3%81%8f%e9%96%8b%e3%81%91%e3%81%aa%e3%81%84%e4%bb%b6%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6%ef%bc%88oplocks%e6%ad%bb%e3%81%99%e3%81%b9%e3%81%97%ef%bc%89.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e7%b5%90%e8%ab%96 aria-label=結論>結論</a></li><li><a href=#%e3%83%8d%e3%82%bf%e5%85%83 aria-label=ネタ元>ネタ元</a></li><li><a href=#smb%e3%83%97%e3%83%ad%e3%83%88%e3%82%b3%e3%83%ab%e3%81%ae%e3%83%90%e3%83%bc%e3%82%b8%e3%83%a7%e3%83%b3%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6 aria-label=SMB（プロトコル）のバージョンについて>SMB（プロトコル）のバージョンについて</a></li><li><a href=#br--oplocks%e3%81%a8%e3%81%af aria-label=Oplocksとは>Oplocksとは</a></li><li><a href=#read-caching%e3%81%a8%e3%81%af aria-label="Read Cachingとは">Read Cachingとは</a></li><li><a href=#oplocks%e3%81%ae%e5%8d%b1%e9%99%ba%e6%80%a7 aria-label=Oplocksの危険性>Oplocksの危険性</a></li><li><a href=#%e5%af%be%e7%ad%96oplocks%e3%82%92%e7%84%a1%e5%8a%b9%e3%81%ab%e3%81%97%e3%82%8d aria-label=対策:Oplocksを無効にしろ>対策:Oplocksを無効にしろ</a></li><li><a href=#smbconf%e3%81%a7oplocks%e3%82%92%e7%84%a1%e5%8a%b9%e3%81%ab%e3%81%99%e3%82%8b aria-label=smb.confでOplocksを無効にする>smb.confでOplocksを無効にする</a></li><li><a href=#blocking-locks aria-label="blocking locks">blocking locks</a></li><li><a href=#%e8%a8%ad%e5%ae%9a%e4%be%8b aria-label=設定例>設定例</a></li><li><a href=#%e5%8f%82%e8%80%83locks-and-oplocks-%e7%a7%81%e8%a8%b3 aria-label="（参考）Locks and Oplocks 私訳">（参考）Locks and Oplocks 私訳</a></li></ul></div></details></div><div class=post-content><p>昨年あたりからWindows XPのサポート終了にともない、Windows 7へクライアントOSを移す企業が多い。<br>私の仕事PCも過日、ついに7に変更された。<br>さすがに色んなところが改善されていて使いやすくなっているのだが、なぜかSambaに置いてあるファイルが壊れたり、誰も開いていないはずなのに読み取り専用でしか開けない事象が頻発した。<br>特に共有設定したOfficeドキュメントで顕著。</p><p>しばらく悩んでいたのだが、Sambaのログにoplocks failedという記録を見つけて（おそらく）対処方法が分かった。<br>以下に示す。<br>Sambaのバージョンは3.6.22である。</p><h2 id=結論>結論<a hidden class=anchor aria-hidden=true href=#結論>#</a></h2><p>smb.confのglobalセクションに以下を書け。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>oplocks = No
</span></span><span style=display:flex><span>blocking locks = No
</span></span></code></pre></div><h2 id=ネタ元>ネタ元<a hidden class=anchor aria-hidden=true href=#ネタ元>#</a></h2><p>ネットを渉猟したところ、やはりOplocksの評判はあまりよくない。</p><p>以下のホワイトペーパーが分かりやすかった。<br>Oplocksとread cachingが原因と断定している。</p><p>Opportunistic Locking and Read Caching on Microsoft Windows Networks<br><a href=http://www.dataaccess.com/whitepapers/opportunlockingreadcaching.html>http://www.dataaccess.com/whitepapers/opportunlockingreadcaching.html</a></p><p>先に進む前にプロトコルとしてのSMBでいくつか確認を。</p><h2 id=smbプロトコルのバージョンについて>SMB（プロトコル）のバージョンについて<a hidden class=anchor aria-hidden=true href=#smbプロトコルのバージョンについて>#</a></h2><p>Windowsファイル共有で使われるプロトコルSMBは、Vistaでバージョン2, 7でバージョン2.1になった。<br>Oplocksとread cachingもバージョン2以降で追加、あるいは強化されている。<br>詳細は以下。</p><p>SMB の新機能<br><a href=http://technet.microsoft.com/ja-jp/library/ff625695.aspx>http://technet.microsoft.com/ja-jp/library/ff625695.aspx</a><br>SMB1⇒2⇒2.1への変化と新機能<br><a href=http://blog.goo.ne.jp/mito_and_tanu/e/10c47629fbb7e7d3d73cbd54a1a9f28d>http://blog.goo.ne.jp/mito_and_tanu/e/10c47629fbb7e7d3d73cbd54a1a9f28d</a></p><h2 id=br--oplocksとは>Oplocksとは<a hidden class=anchor aria-hidden=true href=#br--oplocksとは>#</a></h2><p>ネットワークの効率化を狙う、Windows固有の機能。<br>複数のプロセスが同じファイルをロックでき、なおかつクライアントがデータをキャッシュできる。</p><p>Chapter 17. File and Record Locking<br><a href=http://www.samba.org/samba/docs/man/Samba-HOWTO-Collection/locking.html>http://www.samba.org/samba/docs/man/Samba-HOWTO-Collection/locking.html</a><br><a href=http://www.samba.gr.jp/project/translation/Samba3-HOWTO/locking.html>http://www.samba.gr.jp/project/translation/Samba3-HOWTO/locking.html</a></p><h2 id=read-cachingとは>Read Cachingとは<a hidden class=anchor aria-hidden=true href=#read-cachingとは>#</a></h2><p>Oplocksの一機能。クライアント側でのデータキャッシュ。<br>クライアントがローカルでデータをキャッシュする目的は、ネットワーク越しの書き込み回数を減らすこと、ひいてはネットワークの効率化のため。<br>ファイルの同じ部分（the same region）に対する書き込みをまとめて、一回で済ませる。</p><h2 id=oplocksの危険性>Oplocksの危険性<a hidden class=anchor aria-hidden=true href=#oplocksの危険性>#</a></h2><p>Oplocksが狙い通りに動けば、目的通りネットワークの効率化が図られる。<br>問題なのはネットワークに何か問題が起こり、キャッシュが適切にフラッシュされない場合。ともするとファイルの破壊を引き起こす。<br>とくにデータベースが危険。<br>以下のリンクに詳細が。<br>本記事の末尾に私訳を付す。</p><p>Locks and Oplocks<br><a href=http://www.samba.org/samba/docs/using_samba/ch08.html>http://www.samba.org/samba/docs/using_samba/ch08.html</a></p><h2 id=対策oplocksを無効にしろ>対策:Oplocksを無効にしろ<a hidden class=anchor aria-hidden=true href=#対策oplocksを無効にしろ>#</a></h2><p>ここまで分かれば、対策は簡単。<br>Oplocksを無効にすればよい。<br>無効にする方法には、サーバ側での方法、クライアント側での方法がある。<br>クライアントと言っても、たいていはWindowsであろうが、Windowsで対処しようとするとレジストリの変更が必要になる。<br>さすがにそれは面倒だ。<br>そこでサーバ側、Sambaの設定でOplocksを無効にする。</p><h2 id=smbconfでoplocksを無効にする>smb.confでOplocksを無効にする<a hidden class=anchor aria-hidden=true href=#smbconfでoplocksを無効にする>#</a></h2><p>oplocks = noとすればよい。<br>デフォルト無効にしたければ[global]セクションに、共有ごとに無効にしたければ共有のところに書けばよい。<br>smb.confのmanは一見、共有ごとにしか指定できないように見えるかもしれないが[global]にも使える。<br>また、oplocksはbooleanなのでnoでもfalseでも、はたまた0でも理解してもらえる。</p><p>なお、ファイルごとに有効無効を指定したければveto oplock filesで指定できる。</p><p>smb.confのmanより抜粋</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>oplocks (S)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>This boolean option tells smbd whether to issue oplocks
</span></span><span style=display:flex><span>(opportunistic locks) to file open requests on this share.
</span></span><span style=display:flex><span>（略）
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Default: oplocks = yes
</span></span></code></pre></div><p>smb.confのmanよりPARAMETERS抜粋</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>PARAMETERS
</span></span><span style=display:flex><span>（略）
</span></span><span style=display:flex><span>The letter G in parentheses indicates that a
</span></span><span style=display:flex><span>parameter is specific to the [global] section. The letter S indicates
</span></span><span style=display:flex><span>that a parameter can be specified in a service specific section. All S
</span></span><span style=display:flex><span>parameters can also be specified in the [global] section - in which
</span></span><span style=display:flex><span>case they will define the default behavior for all services.
</span></span></code></pre></div><h2 id=blocking-locks>blocking locks<a hidden class=anchor aria-hidden=true href=#blocking-locks>#</a></h2><p>Sambaはロックの方法を指定できる。<br>blocking locksというものである。<br>これは、ファイルをロックするときに、特定部分だけをロック（range lock）するか、ファイル全体をロックするか、というものである。<br>デフォルトで有効。<br>WindowsのRead Cachingに対応してそうな機能である。<br>加えてmanを見ると、「range lockに失敗すると、タイムアウトするまで何回かrange lockを再試行する」などと書いてある。<br>これも無効にしよう。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>blocking locks (S)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>This parameter controls the behavior of smbd(8) when given a
</span></span><span style=display:flex><span>request by a client to obtain a byte range lock on a region of an
</span></span><span style=display:flex><span>open file, and the request has a time limit associated with it.
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>If this parameter is set and the lock range requested cannot be
</span></span><span style=display:flex><span>immediately satisfied, samba will internally queue the lock
</span></span><span style=display:flex><span>request, and periodically attempt to obtain the lock until the
</span></span><span style=display:flex><span>timeout period expires.
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>If this parameter is set to no, then samba will behave as previous
</span></span><span style=display:flex><span>versions of Samba would and will fail the lock request immediately
</span></span><span style=display:flex><span>if the lock range cannot be obtained.
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Default: blocking locks = yes
</span></span></code></pre></div><h2 id=設定例>設定例<a hidden class=anchor aria-hidden=true href=#設定例>#</a></h2><p>以上を踏まえて、以下のように設定<br>しょぼい英文は勘弁しておくれ。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>[global]
</span></span><span style=display:flex><span>(略)
</span></span><span style=display:flex><span>#
</span></span><span style=display:flex><span><span style=color:#75715e># Disable oplock</span>
</span></span><span style=display:flex><span># It<span style=color:#960050;background-color:#1e0010>&#39;</span>s supposed to improve network performance but causes problems
</span></span><span style=display:flex><span>#
</span></span><span style=display:flex><span><span style=color:#75715e># See:</span>
</span></span><span style=display:flex><span># Opportunistic Locking and Read Caching on Microsoft Windows Networks
</span></span><span style=display:flex><span># http://www.dataaccess.com/whitepapers/opportunlockingreadcaching.html
</span></span><span style=display:flex><span>#
</span></span><span style=display:flex><span>oplocks <span style=color:#f92672>=</span> no
</span></span><span style=display:flex><span>blocking locks = no
</span></span></code></pre></div><p>再起動しておしまい。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ sudo service samba restart
</span></span><span style=display:flex><span>Performing sanity check on Samba configuration: OK
</span></span><span style=display:flex><span>Stopping winbindd.
</span></span><span style=display:flex><span>Waiting for PIDS: 667.
</span></span><span style=display:flex><span>Stopping smbd.
</span></span><span style=display:flex><span>Waiting for PIDS: 664, 664.
</span></span><span style=display:flex><span>Stopping nmbd.
</span></span><span style=display:flex><span>Waiting for PIDS: 661.
</span></span><span style=display:flex><span>Removing stale Samba tdb files: .. done
</span></span><span style=display:flex><span>Starting nmbd.
</span></span><span style=display:flex><span>Starting smbd.
</span></span><span style=display:flex><span>Starting winbindd.
</span></span></code></pre></div><h2 id=参考locks-and-oplocks-私訳>（参考）Locks and Oplocks 私訳<a hidden class=anchor aria-hidden=true href=#参考locks-and-oplocks-私訳>#</a></h2><p><a href=http://www.samba.org/samba/docs/using_samba/ch08.html>http://www.samba.org/samba/docs/using_samba/ch08.html</a><br>Locks and Oplocks</p><p>oplocksの使用によって得られるパフォーマンス増は、大変に望ましいことがほとんどだ。<br>しかしながら、クライアントやネットワークのハードウェアの信頼性が怪しいような状況では、クライアントにデータをキャッシュさせることは大きなリスクになり得る。<br>クライアントが書き込みのためにファイルを開き、oplockを行う場合を考えてみよう。<br>そして他のクライアントが同じファイルを開こうとしたとき、&ldquo;oplock break"要求が最初のクライアントに送られる。<br>もしこの要求が何らかの理由により失敗し、二番目のクライアントがファイルの書き込みをしたとする。<br>二つのプロセスが同時に書き込みをするわけだから、ファイルは簡単に壊れてしまうだろう。<br>残念なことに上記のケースは現実に起こりうる。<br>SMBネットワークにおける複数のWindowsクライアント環境では、このようなおかしな動きは頻繁にみられる。<br>たくさんのクライアントが同時に書き込みを行うデータベースファイルは特に影響を受けてしまう。</p><p>oplocksの失敗するもっと具体的な例を挙げると、それはデータベースファイルが大変に大きい場合である。<br>クライアントがこのようなファイルを開き、oplockを許可されると、非常に大きな遅延が発生する。<br>その一部を修正するためだけであっても、クライアントがファイル全部をキャッシュするからである。<br>このファイルを別のクライアントが開こうとしたとき、状況はさらに悪くなる。<br>二番目のクライアントがファイルを開くためには、最初のクライアントがキャッシュをすべてサーバに書き戻す必要があるからだ。<br>このために、また別の遅延が発生する（しかも双方のクライアントで）。<br>結果として、タイムアウトにより二番目のクライアントがファイルオープンに失敗し、たぶんデータが壊れた旨のWarning messageも併せて表示されるだろう。</p><p>In most cases, the extra performance resulting from the use of oplocks is highly desirable. However, allowing the client to cache data can be a big risk if either the client or network hardware are unreliable. Suppose a client opens a file for writing, creating an oplock on it. When another client also tries to open the file, an oplock break request is sent to the first client. If this request goes unfulfilled for any reason and the second client starts writing to the file, the file can be easily corrupted as a result of the two processes writing to it concurrently. Unfortunately, this scenario is very real. Uncoordinated behavior such as this has been observed many times among Windows clients in SMB networks (with files served by Windows NT/2000 or Samba). Typically, the affected files are database files, which multiple clients open concurrently for writing.</p><p>A more concrete example of oplock failure occurs when database files are very large. If a client is allowed to oplock this kind of file, there can be a huge delay while the client copies the entire file from the server to cache it, even though it might need to update only one record. The situation goes from bad to worse when another client tries to open the oplocked file. The first client might need to write the entire file back to the server before the second client&rsquo;s file open request can succeed. This results in another huge delay (for both clients), which in practice often results in a failed open due to a timeout on the second client, perhaps along with a message warning of possible database corruption!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://nobwak.github.io/tags/freebsd/>FreeBSD</a></li><li><a href=https://nobwak.github.io/tags/linux/>linux</a></li><li><a href=https://nobwak.github.io/tags/samba/>Samba</a></li><li><a href=https://nobwak.github.io/tags/windows/>Windows</a></li></ul><nav class=paginav><a class=prev href=https://nobwak.github.io/posts/2014-01-28-zfs_snapshot%E3%81%AE%E5%B7%AE%E5%88%86send_recv%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6/><span class=title>« Prev Page</span><br><span>zfs snapshotの差分send/recvについて</span></a>
<a class=next href=https://nobwak.github.io/posts/2014-01-23-hadoop%E3%83%95%E3%83%AC%E3%83%B3%E3%83%89%E3%83%AA%E3%83%BC%E3%81%AA%E3%83%87%E3%83%BC%E3%82%BF%E3%81%A8%E3%81%AF/><span class=title>Next Page »</span><br><span>Hadoopフレンドリーなデータとは</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Windows7でsambaのファイルがうまく開けない件について（oplocks死すべし） on twitter" href="https://twitter.com/intent/tweet/?text=Windows7%e3%81%a7samba%e3%81%ae%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%8c%e3%81%86%e3%81%be%e3%81%8f%e9%96%8b%e3%81%91%e3%81%aa%e3%81%84%e4%bb%b6%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6%ef%bc%88oplocks%e6%ad%bb%e3%81%99%e3%81%b9%e3%81%97%ef%bc%89&url=https%3a%2f%2fnobwak.github.io%2fposts%2f2014-01-26-windows7%25E3%2581%25A7samba%25E3%2581%25AE%25E3%2583%2595%25E3%2582%25A1%25E3%2582%25A4%25E3%2583%25AB%25E3%2581%258C%25E3%2581%2586%25E3%2581%25BE%25E3%2581%258F%25E9%2596%258B%25E3%2581%2591%25E3%2581%25AA%25E3%2581%2584%25E4%25BB%25B6%25E3%2581%25AB%25E3%2581%25A4%25E3%2581%2584%25E3%2581%25A6oplocks%25E6%25AD%25BB%25E3%2581%2599%25E3%2581%25B9%25E3%2581%2597%2f&hashtags=FreeBSD%2clinux%2cSamba%2cWindows"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Windows7でsambaのファイルがうまく開けない件について（oplocks死すべし） on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fnobwak.github.io%2fposts%2f2014-01-26-windows7%25E3%2581%25A7samba%25E3%2581%25AE%25E3%2583%2595%25E3%2582%25A1%25E3%2582%25A4%25E3%2583%25AB%25E3%2581%258C%25E3%2581%2586%25E3%2581%25BE%25E3%2581%258F%25E9%2596%258B%25E3%2581%2591%25E3%2581%25AA%25E3%2581%2584%25E4%25BB%25B6%25E3%2581%25AB%25E3%2581%25A4%25E3%2581%2584%25E3%2581%25A6oplocks%25E6%25AD%25BB%25E3%2581%2599%25E3%2581%25B9%25E3%2581%2597%2f&title=Windows7%e3%81%a7samba%e3%81%ae%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%8c%e3%81%86%e3%81%be%e3%81%8f%e9%96%8b%e3%81%91%e3%81%aa%e3%81%84%e4%bb%b6%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6%ef%bc%88oplocks%e6%ad%bb%e3%81%99%e3%81%b9%e3%81%97%ef%bc%89&summary=Windows7%e3%81%a7samba%e3%81%ae%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%8c%e3%81%86%e3%81%be%e3%81%8f%e9%96%8b%e3%81%91%e3%81%aa%e3%81%84%e4%bb%b6%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6%ef%bc%88oplocks%e6%ad%bb%e3%81%99%e3%81%b9%e3%81%97%ef%bc%89&source=https%3a%2f%2fnobwak.github.io%2fposts%2f2014-01-26-windows7%25E3%2581%25A7samba%25E3%2581%25AE%25E3%2583%2595%25E3%2582%25A1%25E3%2582%25A4%25E3%2583%25AB%25E3%2581%258C%25E3%2581%2586%25E3%2581%25BE%25E3%2581%258F%25E9%2596%258B%25E3%2581%2591%25E3%2581%25AA%25E3%2581%2584%25E4%25BB%25B6%25E3%2581%25AB%25E3%2581%25A4%25E3%2581%2584%25E3%2581%25A6oplocks%25E6%25AD%25BB%25E3%2581%2599%25E3%2581%25B9%25E3%2581%2597%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Windows7でsambaのファイルがうまく開けない件について（oplocks死すべし） on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fnobwak.github.io%2fposts%2f2014-01-26-windows7%25E3%2581%25A7samba%25E3%2581%25AE%25E3%2583%2595%25E3%2582%25A1%25E3%2582%25A4%25E3%2583%25AB%25E3%2581%258C%25E3%2581%2586%25E3%2581%25BE%25E3%2581%258F%25E9%2596%258B%25E3%2581%2591%25E3%2581%25AA%25E3%2581%2584%25E4%25BB%25B6%25E3%2581%25AB%25E3%2581%25A4%25E3%2581%2584%25E3%2581%25A6oplocks%25E6%25AD%25BB%25E3%2581%2599%25E3%2581%25B9%25E3%2581%2597%2f&title=Windows7%e3%81%a7samba%e3%81%ae%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%8c%e3%81%86%e3%81%be%e3%81%8f%e9%96%8b%e3%81%91%e3%81%aa%e3%81%84%e4%bb%b6%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6%ef%bc%88oplocks%e6%ad%bb%e3%81%99%e3%81%b9%e3%81%97%ef%bc%89"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Windows7でsambaのファイルがうまく開けない件について（oplocks死すべし） on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnobwak.github.io%2fposts%2f2014-01-26-windows7%25E3%2581%25A7samba%25E3%2581%25AE%25E3%2583%2595%25E3%2582%25A1%25E3%2582%25A4%25E3%2583%25AB%25E3%2581%258C%25E3%2581%2586%25E3%2581%25BE%25E3%2581%258F%25E9%2596%258B%25E3%2581%2591%25E3%2581%25AA%25E3%2581%2584%25E4%25BB%25B6%25E3%2581%25AB%25E3%2581%25A4%25E3%2581%2584%25E3%2581%25A6oplocks%25E6%25AD%25BB%25E3%2581%2599%25E3%2581%25B9%25E3%2581%2597%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Windows7でsambaのファイルがうまく開けない件について（oplocks死すべし） on whatsapp" href="https://api.whatsapp.com/send?text=Windows7%e3%81%a7samba%e3%81%ae%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%8c%e3%81%86%e3%81%be%e3%81%8f%e9%96%8b%e3%81%91%e3%81%aa%e3%81%84%e4%bb%b6%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6%ef%bc%88oplocks%e6%ad%bb%e3%81%99%e3%81%b9%e3%81%97%ef%bc%89%20-%20https%3a%2f%2fnobwak.github.io%2fposts%2f2014-01-26-windows7%25E3%2581%25A7samba%25E3%2581%25AE%25E3%2583%2595%25E3%2582%25A1%25E3%2582%25A4%25E3%2583%25AB%25E3%2581%258C%25E3%2581%2586%25E3%2581%25BE%25E3%2581%258F%25E9%2596%258B%25E3%2581%2591%25E3%2581%25AA%25E3%2581%2584%25E4%25BB%25B6%25E3%2581%25AB%25E3%2581%25A4%25E3%2581%2584%25E3%2581%25A6oplocks%25E6%25AD%25BB%25E3%2581%2599%25E3%2581%25B9%25E3%2581%2597%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Windows7でsambaのファイルがうまく開けない件について（oplocks死すべし） on telegram" href="https://telegram.me/share/url?text=Windows7%e3%81%a7samba%e3%81%ae%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%8c%e3%81%86%e3%81%be%e3%81%8f%e9%96%8b%e3%81%91%e3%81%aa%e3%81%84%e4%bb%b6%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6%ef%bc%88oplocks%e6%ad%bb%e3%81%99%e3%81%b9%e3%81%97%ef%bc%89&url=https%3a%2f%2fnobwak.github.io%2fposts%2f2014-01-26-windows7%25E3%2581%25A7samba%25E3%2581%25AE%25E3%2583%2595%25E3%2582%25A1%25E3%2582%25A4%25E3%2583%25AB%25E3%2581%258C%25E3%2581%2586%25E3%2581%25BE%25E3%2581%258F%25E9%2596%258B%25E3%2581%2591%25E3%2581%25AA%25E3%2581%2584%25E4%25BB%25B6%25E3%2581%25AB%25E3%2581%25A4%25E3%2581%2584%25E3%2581%25A6oplocks%25E6%25AD%25BB%25E3%2581%2599%25E3%2581%25B9%25E3%2581%2597%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://nobwak.github.io>nobwak's Lair</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>