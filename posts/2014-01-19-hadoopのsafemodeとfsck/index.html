<!DOCTYPE html>
<html lang="ja-JP">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Nobwak&#39;s Lair  | hadoopのsafemodeとfsck</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.54.0" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.d98f2eb6bcd1eaedb7edf166bd16af26.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="hadoopのsafemodeとfsck" />
<meta property="og:description" content="Hadoopのnamenode兼datanodeが電源瞬断のせいで壊れてしもうた。 勉強用のHadoopなのでダメージはないのだが、せっかくな" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://nobwak.github.io/posts/2014-01-19-hadoop%E3%81%AEsafemode%E3%81%A8fsck/" />
<meta property="article:published_time" content="2014-01-19T20:02:43&#43;09:00"/>
<meta property="article:modified_time" content="2014-01-19T20:02:43&#43;09:00"/>

<meta itemprop="name" content="hadoopのsafemodeとfsck">
<meta itemprop="description" content="Hadoopのnamenode兼datanodeが電源瞬断のせいで壊れてしもうた。 勉強用のHadoopなのでダメージはないのだが、せっかくな">


<meta itemprop="datePublished" content="2014-01-19T20:02:43&#43;09:00" />
<meta itemprop="dateModified" content="2014-01-19T20:02:43&#43;09:00" />
<meta itemprop="wordCount" content="1581">



<meta itemprop="keywords" content="hadoop," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="hadoopのsafemodeとfsck"/>
<meta name="twitter:description" content="Hadoopのnamenode兼datanodeが電源瞬断のせいで壊れてしもうた。 勉強用のHadoopなのでダメージはないのだが、せっかくな"/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://nobwak.github.io/" class="f3 fw2 hover-white no-underline white-90 dib">
      Nobwak&#39;s Lair
    </a>
    <div class="flex-l items-center">
      

      
      











    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1">hadoopのsafemodeとfsck</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2014-01-19T20:02:43&#43;09:00">January 19, 2014</time>      
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l">

<p>Hadoopのnamenode兼datanodeが電源瞬断のせいで壊れてしもうた。<br />
勉強用のHadoopなのでダメージはないのだが、せっかくなのでfsckなどを試した結果を記す。<br />
hadoop-1.0.0。<br />
OS側でもfsckはしておいた。</p>

<h2 id="span-style-text-decoration-underline-サマリ-span"><span style="text-decoration: underline;">サマリ</span></h2>

<ul>
<li>HDFSにもfsckがある。</li>
<li>hadoop fsckでチェック、修正できる。</li>
<li>hadoop fsckと叩けば使い方の簡単な説明が表示される。</li>
<li>namenodeがsafemodeのためにHDFSが読み取り専用になっていることがある。</li>
<li>読み取り専用ではfsckで修正できないので、safemodeから出る必要がある。</li>
</ul>

<h2 id="span-style-text-decoration-underline-hdfsでのfsck-span"><span style="text-decoration: underline;">HDFSでのfsck</span></h2>

<p>hadoop fsck ＜path＞と指定すればよい。<br />
CORRUPT!とのことで、壊れておりますなあ。</p>

<pre><code class="language-console">$ hadoop fsck /
FSCK started by hadoop from /172.29.17.159 for path / at Wed Dec 25 18:51:37 JST 2013
（略）
/var/hadoop/mapred/system/jobtracker.info: MISSING 1 blocks of total size 4 B.Status: CORRUPT
Total size: 45638364128 B
Total dirs: 5321
Total files: 13059
Total blocks (validated): 9819 (avg. block size 4647964 B)
********************************
CORRUPT FILES: 2470
MISSING BLOCKS: 2498
MISSING SIZE: 15590981155 B
CORRUPT BLOCKS: 2498
********************************
Minimally replicated blocks: 7321 (74.559525 %)
Over-replicated blocks: 0 (0.0 %)
Under-replicated blocks: 7321 (74.559525 %)
Mis-replicated blocks: 0 (0.0 %)
Default replication factor: 2
Average block replication: 0.7455953
Corrupt blocks: 2498
Missing replicas: 7321 (100.0 %)
Number of data-nodes: 1
Number of racks: 1
FSCK ended at Wed Dec 25 18:51:38 JST 2013 in 1185 milliseconds

The filesystem under path '/' is CORRUPT
</code></pre>

<h2 id="span-style-text-decoration-underline-壊れている場合の対処-消去か移動-span"><span style="text-decoration: underline;">壊れている場合の対処:消去か移動</span></h2>

<p>壊れている場合には対処が二つ。<br />
壊れているブロックを消すか、lost+foundに移すか。<br />
消す場合には-delete, 移す場合には-moveを指定する。<br />
以下は消した場合の例&hellip;.なのだが、namenodeがsafemodeにいるので変更が出来ないとのこと。</p>

<pre><code class="language-console">$ hadoop fsck / -delete
FSCK started by hadoop from /172.29.17.159 for path / at Wed Dec 25 18:58:29 JST 2013
.
/tmp/hadoop-hadoop/mapred/staging/hadoop/.staging/job_201308300823_0001/job.jar: CORRUPT block blk_3947350403157044322

/tmp/hadoop-hadoop/mapred/staging/hadoop/.staging/job_201308300823_0001/job.jar: MISSING 1 blocks of total size 66249 B.FSCK ended at Wed Dec 25 08:58:29 JST 2013 in 5 milliseconds
Cannot delete /tmp/hadoop-hadoop/mapred/staging/hadoop/.staging/job_201308300823_0001/job.jar. Name node is in safe mode.
The ratio of reported blocks 0.7456 has not reached the threshold 0.9990. Safe mode will be turned off automatically.

Fsck on path '/' FAILED
</code></pre>

<h2 id="span-style-text-decoration-underline-safemodeとは-span"><span style="text-decoration: underline;">safemodeとは</span></h2>

<p>そもそもnameodeは通常の動作として、起動時には状態がsafemodeである。<br />
safenodeのまま待機をしているうちに、datanodeが起動し、保管しているブロックの報告をnamenodeに行う。<br />
namenodeは、充分なブロックの確認ができれば自動的にsafemodeを出る。<br />
「充分なブロック」がどれくらいか、は設定できる。</p>

<p>safemodeのときは読み取り専用になり、複製や消去もできないが、手動でsafemodeに入ったり出たりすることができる。</p>

<p>以下、<a href="https://hadoop.apache.org/docs/r1.2.1/commands_manual.html" target="_blank">公式</a>からの引用</p>

<blockquote>
<p>Safe mode is entered automatically at Namenode startup, and leaves safe mode automatically when the configured minimum percentage of blocks satisfies the minimum replication condition. Safe mode can also be entered manually, but then it can only be turned off manually as well.<br />
Safe mode maintenance command. Safe mode is a Namenode state in which it<br />
1. does not accept changes to the name space (read-only)<br />
2. does not replicate or delete blocks.</p>
</blockquote>

<p>今回、問題の発生したnamenodeはdatanodeも兼ねている。<br />
電源瞬断でブロックが壊れているからブロックの報告はできないし、そもそもnamenodeが保管しているメタデータも壊れている。<br />
ボロボロである。<br />
したがって、いつまで待ってもsafemodeから出るはずがない。<br />
そこで手動でsafemodeを解除する。</p>

<h2 id="span-style-text-decoration-underline-safemodeの操作-span"><span style="text-decoration: underline;">safemodeの操作</span></h2>

<p>safemodeの操作はhadoop dfsadmin -safemodeに続けて行う。<br />
getで状態を得る。<br />
enterでsafemodeに入る。<br />
leaveでsafemodeから出る。<br />
面白いのは、wait。<br />
safemodeから出たらコマンド実行する、というもの。</p>

<pre><code class="language-console"># 状態を得る。
$ hadoop dfsadmin -safemode get

# 終わってからコマンド実行
$ hadoop dfsadmin -safemode wait

# safemodeに入る。
$ hadoop dfsadmin -safemode enter

# safemodeから出る。
$ hadoop dfsadmin -safemode leave
</code></pre>

<p>以下、実際の例。<br />
safe modeがONになっているので、OFFに。</p>

<pre><code class="language-console">$ hadoop dfsadmin -safemode get
Safe mode is ON

$ hadoop dfsadmin -safemode leave
Safe mode is OFF
</code></pre>

<p>改めてfsck / -delete<br />
blockが2000個くらい消えた。ま、まあ勉強用だし（震え声）</p>

<pre><code class="language-console">$ hadoop fsck / -delete
FSCK started by hadoop from /172.29.17.159 for path / at Wed Dec 25 19:05:54 JST 2013
（略）
.......Status: HEALTHY
Total size: 29928657533 B
Total dirs: 5321
Total files: 10589
Total blocks (validated): 7319 (avg. block size 4089173 B)
Minimally replicated blocks: 7319 (100.0 %)
Over-replicated blocks: 0 (0.0 %)
Under-replicated blocks: 7319 (100.0 %)
Mis-replicated blocks: 0 (0.0 %)
Default replication factor: 2
Average block replication: 1.0
Corrupt blocks: 0
Missing replicas: 7319 (100.0 %)
Number of data-nodes: 1
Number of racks: 1
FSCK ended at Wed Dec 25 19:05:55 JST 2013 in 1696 milliseconds

The filesystem under path '/' is HEALTHY
</code></pre>

<p>HEALTYになったので、これでhadoopが使える状態に戻った。<br />
以上。</p>
<ul class="pa0">
  
   <li class="list">
     <a href="/tags/hadoop" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">hadoop</a>
   </li>
  
</ul>
<div class="mt6">
        
      </div>
    </section>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://nobwak.github.io/" >
    &copy; 2019 Nobwak&#39;s Lair
  </a>
    <div>










</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
