<!DOCTYPE html>
<html lang="ja-JP">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Nobwak&#39;s Lair  | [FreeBSD] ezjailを試そう</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.54.0" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.d98f2eb6bcd1eaedb7edf166bd16af26.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="[FreeBSD] ezjailを試そう" />
<meta property="og:description" content="Jail FreeBSDにはJailという技術がある。 Jailとは、OSレベルの仮想化技術だ。 Jailを使うと、FreeBSDマシン上にいくつもの独" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://nobwak.github.io/posts/2013-09-16-freebsd_ezjail%E3%82%92%E8%A9%A6%E3%81%9D%E3%81%86/" />
<meta property="article:published_time" content="2013-09-16T20:49:18&#43;09:00"/>
<meta property="article:modified_time" content="2013-09-16T20:49:18&#43;09:00"/>

<meta itemprop="name" content="[FreeBSD] ezjailを試そう">
<meta itemprop="description" content="Jail FreeBSDにはJailという技術がある。 Jailとは、OSレベルの仮想化技術だ。 Jailを使うと、FreeBSDマシン上にいくつもの独">


<meta itemprop="datePublished" content="2013-09-16T20:49:18&#43;09:00" />
<meta itemprop="dateModified" content="2013-09-16T20:49:18&#43;09:00" />
<meta itemprop="wordCount" content="2469">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[FreeBSD] ezjailを試そう"/>
<meta name="twitter:description" content="Jail FreeBSDにはJailという技術がある。 Jailとは、OSレベルの仮想化技術だ。 Jailを使うと、FreeBSDマシン上にいくつもの独"/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://nobwak.github.io/" class="f3 fw2 hover-white no-underline white-90 dib">
      Nobwak&#39;s Lair
    </a>
    <div class="flex-l items-center">
      

      
      











    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1">[FreeBSD] ezjailを試そう</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2013-09-16T20:49:18&#43;09:00">September 16, 2013</time>      
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l">

<h2 id="span-style-text-decoration-underline-jail-span"><span style="text-decoration: underline;">Jail</span></h2>

<p>FreeBSDにはJailという技術がある。</p>

<p>Jailとは、OSレベルの仮想化技術だ。<br />
Jailを使うと、FreeBSDマシン上にいくつもの独立したシステムを構築できる。</p>

<p>たとえば、一つのFreeBSDのうえに、Samba, Apacheをそれぞれ独立させて構築させることができる。<br />
独立、というのは、Apache側のシステムで何が起こっても、Samba側のシステム、ホストのFreeBSDには何の影響もないということ。</p>

<p>もっと深いところで仮想化するESXiやらXenやらと比べると、オーバーヘッドが小さいという利点がある（と思ってます）。<br />
これらの方法だと、各サービスを独立させたいときには、OSごとインストールする必要があるから。<br />
（仮にあるマシン上でDHCPサーバ, DNS, Samba, Apacheを動かすとして、それぞれ向けにOSをインストール、というのはさすがに辛い。）</p>

<p>詳しくは下記。</p>

<p><a href="http://ja.wikipedia.org/wiki/FreeBSD_jail" target="_blank"><a href="http://ja.wikipedia.org/wiki/FreeBSD_jail">http://ja.wikipedia.org/wiki/FreeBSD_jail</a></a></p>

<blockquote>
<p>Jailの利点<br />
仮想化: 各jailはホストマシン上で動く仮想機械であり、独自のファイルシステムやプロセス空間、ユーザーアカウントを持つ。jailの中のプロセスからは実際のシステムなのかjailの中なのかはほぼ区別できない。<br />
安全性: 各jailは他のjailにアクセスできないようになっており、安全性が高まっている。<br />
権限委譲の簡素化: 管理者権限のスコープがjail内に制限されているため、システムの管理者は本来管理者権限が必要な仕事を、計算機全体を操作する権限を渡すことなく行わせることが出来る。</p>
</blockquote>

<h2 id="span-style-text-decoration-underline-jail-でなくezjailにしよう-span"><span style="text-decoration: underline;">Jail&hellip;でなくezjailにしよう。</span></h2>

<p>FreeBSD Handbookより抜粋する。</p>

<blockquote>
<p>Jailのセットアップには、FreeBSDとその使用方法についての高度な経験が必要である。<br />
下記に示す手順が複雑と感じるならば、sysutils/ezjailなどの、より簡単なシステムを検討せよ<br />
16.6.1.1. Design<br />
<a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/jails-application.html" target="_blank"><a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/jails-application.html">http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/jails-application.html</a></a></p>
</blockquote>

<p>ひとめ見てウンザリしたのでezjailにする。</p>

<h2 id="span-style-text-decoration-underline-ezjailたったこれだけ-インストールと設定-span"><span style="text-decoration: underline;">ezjailたったこれだけ（インストールと設定）。</span></h2>

<p>チュートリアルはここにある。<br />
 <a href=" http://erdgeist.org/arts/software/ezjail/" target="_blank"><a href="http://erdgeist.org/arts/software/ezjail/">http://erdgeist.org/arts/software/ezjail/</a></a></p>

<p>インストールはpkgから。</p>

<pre><code class="language-console"># pkg_add ezjail
</code></pre>

<p>そして最低限の前準備。<br />
/etc/rc.confへの追加。</p>

<pre><code class="language-console"># ezjail
ezjail_enable=&quot;YES&quot;
</code></pre>

<p>ezjail.confへの追記。</p>

<pre><code class="language-console">ezjail_ftphost=ftp2.jp.freebsd.org
</code></pre>

<p>ezjailはFreeBSDの各種データをftpサーバからダウンロードする。<br />
デフォルトだと本家のftpサーバに繋がってしまうので、最寄りのftpサーバを指定する。</p>

<h2 id="span-style-text-decoration-underline-jailたったこれだけ-jail環境の構築-span"><span style="text-decoration: underline;">Jailたったこれだけ（Jail環境の構築）</span></h2>

<p>ここまで来たら、Jail環境そのものの初期設定をする。</p>

<p>ezjail-admin installが初回設定用のコマンドで、使用するのは原則、一回だけでよい。<br />
このコマンドで、Jail関連のディレクトリやらベース環境が作られる。</p>

<pre><code class="language-console">$ sudo ezjail-admin install
Your system is 9.2-RC3. Normally FTP-servers don't provide non-RELEASE-builds.
Querying your ftp-server... The ftp server you specified (ftp2.jp.freebsd.org) seems to provide the following builds:
drwxr-xr-x 2 ftp ftp 4096 Sep 13 15:43 10.0-ALPHA1
lrwxrwxrwx 1 ftp ftp 14 Feb 16 2013 8.3-RELEASE -&gt; ../8.3-RELEASE
drwxr-xr-x 2 ftp ftp 4096 May 22 12:59 9.1-RELEASE
drwxr-xr-x 2 ftp ftp 4096 Aug 16 20:47 9.2-RC2
drwxr-xr-x 2 ftp ftp 4096 Sep 11 22:14 9.2-RC4
drwxr-xr-x 6 ftp ftp 4096 Sep 13 16:35 ISO-IMAGES
Release [ 9.2-RC3 ]:
</code></pre>

<p>ezjailはホストOSと同じバージョンで環境を作ろうとする。<br />
しかしホストOSがRELEASEビルドでない場合、言い換えるとホストOSのバージョンがftpサーバに存在しない場合には、上記の通り自分で指定をしなければならない。</p>

<p>この状態なら9.2-RC4でしょうなあ。</p>

<p>なお、バージョンをどのように判定しているかというと、ホストOSでuname -rを実行したときの出力と、ftpサーバのディレクトリとのマッチングである。</p>

<pre><code class="language-console">Release [ 9.2-RC3 ]:9.2-RC4
(中略)
/usr/jails/basejail/usr/lib32/libalias_pptp.a
/usr/jails/basejail/usr/lib32/libusb_p.a
/usr/jails/basejail/usr/lib32/libalias_ftp.so
110276 blocks
Note: a non-standard /etc/make.conf was copied to the template jail in order to get the ports collection running inside jails.
$
</code></pre>

<p>デフォルト設定では、/usr/jailsに各種ファイルが作られる。</p>

<pre><code class="language-console">$ ls /usr/jails/
basejail flavours newjail
</code></pre>

<h2 id="span-style-text-decoration-underline-jailたったこれだけ-jailホストの構築と起動-span"><span style="text-decoration: underline;">Jailたったこれだけ（Jailホストの構築と起動）</span></h2>

<p>たったこれだけと言いつつJailホストの構築までが長かった。<br />
ezjail-admin createでjailホストを作り、ezjail-admin startでjailホストを起動する。<br />
ezjail-admin consoleでjailホストのコンソールにアクセスする。<br />
と言う流れ。</p>

<p>Jailホストに192.168.1.199というIPアドレスを付与するとし、また、ホストマシンのネットワークIFがem0であるとして、以下のように。</p>

<pre><code class="language-console">$ sudo ezjail-admin create example 'em0|192.168.1.199'
（中略）
/usr/jails/example/./sys
/usr/jails/example/./basejail
3146 blocks
Warning: IP em0|192.168.100.201 not configured on a local interface.
$
</code></pre>

<p>/usr/jailsの下にexampleとして作られたことが分かる。</p>

<pre><code class="language-console">$ ls /usr/jails
basejail example flavours newjail
</code></pre>

<p>そして起動</p>

<pre><code class="language-console">$ sudo ezjail-admin start example
Configuring jails:.
Starting jails: example.
$
</code></pre>

<p>コンソールへ</p>

<pre><code class="language-console">$ sudo ezjail-admin console example
FreeBSD 9.2-RC3 (GENERIC) #0 r254795: Sat Aug 24 20:25:04 UTC 2013
Welcome to FreeBSD!
（中略）
root@example:~ #
root@example:~# uname -a
FreeBSD example 9.2-RC3 FreeBSD 9.2-RC3 #0 r254795: Sat Aug 24 20:25:04 UTC 2013 root@bake.isc.freebsd.org:/usr/obj/usr/src/sys/GENERIC amd64
</code></pre>

<h2 id="span-style-text-decoration-underline-jailたったこれだけ-とは言うけれど-span"><span style="text-decoration: underline;">Jailたったこれだけ、とは言うけれど。</span></h2>

<p>jailホストは起動したけれども、ご覧のようにネットには出ていけない。これはresolv.confがないから。<br />
時刻もUTCになっている。<br />
また、驚くことにrc.confもない。</p>

<pre><code class="language-console">root@example:~ # ftp ftp2.jp.freebsd.org
ftp: Can't lookup `ftp2.jp.freebsd.org:ftp': hostname nor servname provided, or not known
ftp&gt; bye
root@example:~ # date
Sun Sep 15 13:51:21 UTC 2013
root@example:~ # cat /etc/rc.conf
cat: /etc/rc.conf: No such file or directory
root@example:~ #
</code></pre>

<p>Listenポートを調べてみると、あーあ、sendmailやsyslogdがListenしてしまっている。</p>

<pre><code class="language-console">root@example:~ # sockstat -l4
USER COMMAND PID FD PROTO LOCAL ADDRESS FOREIGN ADDRESS
root sendmail 1322 3 tcp4 192.168.100.201:25 *:*
root syslogd 1268 6 udp4 192.168.100.201:514 *:*
root@example:~ #
</code></pre>

<p>先述のチュートリアルにあるQuickStartは早いものの、かように設定が足りません。<br />
そのため、けっこう基本的なところから自分で構築していかなければならない。<br />
ということで、ezjailの設定を詰めることにして、試しに作ったjailホストは消してしまおう。</p>

<p>jailホストからlogoutし、ezjail-adminでstopし、deleteすればOK。</p>

<pre><code class="language-console">root@example:~ # logout
$ sudo ezjail-admin stop example
パスワード:
Stopping jails: example.
$ sudo ezjail-admin delete -w example
$ ls /usr/jails
basejail flavours newjail
$
</code></pre>

<p>deleteのときに-wを付け忘れると、/usr/jails/exampleが残る。<br />
もちろん手動で消すこともできるが、schgフラグが立っているので簡単には消せない。</p>

<pre><code class="language-console">$ sudo ezjail-admin delete example
$ ls
basejail example flavours newjail
$ sudo rm -Rf ./example
rm: ./example/var/empty: Operation not permitted
rm: ./example/var: Directory not empty
rm: ./example: Directory not empty
$
</code></pre>

<p>こういう場合には、schgフラグを消してからrmすること。</p>

<pre><code class="language-console">$ sudo chflags -R noschg ./example
$ sudo rm -Rf ./example
$ ls
basejail flavours newjail
$
</code></pre>

<p>また、deleteの際に-wfとすると、jailを止めてから削除してくれる。</p>

<pre><code class="language-console">ezjail-admin delete -wf example
</code></pre>

<p>ezjailの設定は記事を改めてまとめる。</p>
<ul class="pa0">
  
</ul>
<div class="mt6">
        
      </div>
    </section>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://nobwak.github.io/" >
    &copy; 2019 Nobwak&#39;s Lair
  </a>
    <div>










</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
